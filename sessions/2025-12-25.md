# Session Notes - December 25, 2025

## MPU6050 I2C Communication Fix

### Problem Identified
- MPU6050 sensor required I2C speed of only 10kHz to work reliably
- Same sensor worked flawlessly at 400kHz on another board with identical wiring
- Issue was determined to be board-specific, not code or sensor related

### Root Cause
ESP32's internal pull-up resistors (~45kΩ) are too weak for reliable I2C communication at standard speeds, especially on this particular board.

### Hardware Solution Implemented
1. **Added external 4.7kΩ pull-up resistors:**
   - One from SDA (GPIO21) to 3.3V
   - One from SCL (GPIO22) to 3.3V
   - Resistors can be placed at either ESP32 or MPU6050 end of the bus

2. **Added decoupling capacitors to MPU6050:**
   - 104 ceramic capacitor (100nF) for high-frequency noise filtering
   - 100µF electrolytic capacitor for bulk power supply stability

### Software Changes

#### I2C Configuration Updates
- Disabled internal pull-ups (now using external 4.7kΩ resistors)
- Increased I2C frequency from 10kHz → 100kHz → 400kHz
- Configuration in `main.c`:
```c
#define I2C_MASTER_FREQ_HZ   400000    // 400kHz with 4.7kΩ external pull-ups

i2c_config_t conf = {
    .mode = I2C_MODE_MASTER,
    .sda_io_num = I2C_MASTER_SDA_IO,
    .scl_io_num = I2C_MASTER_SCL_IO,
    .sda_pullup_en = GPIO_PULLUP_DISABLE,  // Using external 4.7kΩ pull-ups
    .scl_pullup_en = GPIO_PULLUP_DISABLE,  // Using external 4.7kΩ pull-ups
    .master.clk_speed = I2C_MASTER_FREQ_HZ,
};
```

#### MPU6050 Data Reading Improvements
- Changed from 3 separate I2C reads to single 14-byte burst read
- More efficient and reliable communication
- Reads all sensor data in one transaction: accelerometer (6 bytes) + temperature (2 bytes) + gyroscope (6 bytes)

#### Debug Output Added
Added comprehensive serial output every 100ms showing:
```
MPU6050 RAW | AccXYZ: raw values | GyroXYZ: raw values | Temp: raw (°C)
MPU6050  G  | AccXYZ: G-forces   | GyroXYZ: °/s values
MPU6050 ANG | Pitch: degrees     | Roll: degrees
```

#### Bug Fix: Pitch/Roll Swap
- Fixed issue where pitch and roll values were swapped in the display
- Corrected mapping between calculated angles and display variables

### Documentation Updates
Updated `documentation/mpu6050_advisory.md` with:
- Hardware requirements for external pull-up resistors
- Decoupling capacitor specifications
- Software configuration details
- Troubleshooting guide

### Results
- MPU6050 now operates reliably at 400kHz (40x speed improvement)
- Stable readings with proper decoupling
- Correct pitch/roll orientation
- Raw data output for debugging and verification

### Files Modified
- `main/main.c` - I2C configuration and MPU6050 reading task
- `documentation/mpu6050_advisory.md` - Comprehensive hardware/software documentation

### Lessons Learned
1. ESP32 internal pull-ups are often insufficient for I2C at standard speeds
2. External 4.7kΩ pull-ups are essential for reliable 400kHz operation
3. Board-specific signal integrity issues can require hardware fixes
4. Burst reading (single transaction) is more reliable than multiple separate reads
5. Proper decoupling (ceramic + electrolytic) is critical for sensor stability
