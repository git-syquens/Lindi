# Session Notes - December 22, 2025

## Digital Clock Toggle Feature

### Objectives
- Add toggle button to switch between analog and digital clock displays
- Store user preference in NVS
- Make digital clock significantly larger when it's the main display

### Implementation

1. **Toggle Button**
   - Location: Top-left corner of start screen (40x30px)
   - Label: "dgt clk" (Montserrat 12pt font)
   - Position: 5px from top, 5px from left

2. **Digital Clock Enhancements**
   - Font: Changed from Montserrat 16 to Montserrat 48 (3x larger)
   - Alignment: LV_ALIGN_CENTER (same as analog clock)
   - Removed digital time label from above analog clock

3. **Analog Clock Sizing**
   - Increased from 126x126 to 139x139 (110% increase as requested)

4. **NVS Storage**
   - Namespace: "lindi_cfg"
   - Key: "digital_mode"
   - Type: uint8_t (0=analog, 1=digital)
   - Functions created:
     * `load_digital_clock_mode_setting()` - loads preference on startup
     * `save_digital_clock_mode_setting()` - saves when button pressed

5. **Visibility Logic**
   - Initial state loaded from NVS on startup
   - Toggle callback switches visibility and saves new state
   - Both clocks exist in memory, only one visible at a time

### Technical Issues Encountered

1. **Font Not Enabled**
   - Problem: Montserrat 12 and 48 not compiled in
   - Solution: Enabled CONFIG_LVGL_FONT_MONTSERRAT_12=y and CONFIG_LVGL_FONT_MONTSERRAT_48=y in sdkconfig

2. **Partition Size Too Small**
   - Problem: Binary size 0x10f320 exceeded 1MB partition (0x100000)
   - Root cause: Adding two large fonts increased binary size
   - Solution: 
     * Created custom partitions.csv with 2MB app partition
     * Changed CONFIG_PARTITION_TABLE_CUSTOM=y in sdkconfig
     * Updated CONFIG_PARTITION_TABLE_FILENAME="partitions.csv"

3. **Flash Size Mismatch**
   - Problem: Partition table requires 2.1MB but flash configured as 2MB
   - Solution: Changed flash size to 4MB (CONFIG_ESPTOOLPY_FLASHSIZE_4MB=y)

### Files Modified

- main/main.c:
  * Added `digital_clock_mode` static variable
  * Added `load_digital_clock_mode_setting()` function
  * Added `save_digital_clock_mode_setting()` function
  * Added `digital_clock_toggle_cb()` callback
  * Modified clock widget creation to include toggle button
  * Modified clock fonts and sizing
  * Added initial visibility logic

- partitions.csv (NEW):
  * nvs: 24KB @ 0x9000
  * phy_init: 4KB @ 0xf000
  * factory: 2MB @ 0x10000

- sdkconfig:
  * Enabled LVGL_FONT_MONTSERRAT_12
  * Enabled LVGL_FONT_MONTSERRAT_48
  * Changed to custom partition table
  * Changed flash size from 2MB to 4MB

### Build Status
- ✅ Initial build with test mode completed successfully
- ✅ Translations and cleanup applied:
  * All Chinese comments translated to English  
  * Project renamed from lvgl-demo to lindi
  * Test mode removed - now showing actual time
- ✅ Second build in progress with real-time display

### Next Steps (After Verification)
1. Complete build and flash to device
2. Test toggle button functionality
3. Verify analog clock hand alignment still correct
4. Verify digital clock displays properly at 48pt
5. Test NVS persistence across reboots
6. Remove/comment test mode code once analog clock verified working

### Notes
- Test mode still active (cycles through 01:10:15, 15:00:20, 17:40:50 every 10 seconds)
- Need to remove test mode for production use
- Analog clock final configuration: 360°, 60 tick marks, rotation_offset=30
