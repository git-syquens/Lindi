# Session Notes - December 22, 2025

## Digital Clock Toggle Feature

### Objectives
- Add toggle button to switch between analog and digital clock displays
- Store user preference in NVS
- Make digital clock significantly larger when it's the main display

### Implementation

1. **Toggle Button**
   - Location: Top-left corner of start screen (40x30px)
   - Label: "dgt clk" (Montserrat 12pt font)
   - Position: 5px from top, 5px from left

2. **Digital Clock Enhancements**
   - Font: Changed from Montserrat 16 to Montserrat 48 (3x larger)
   - Alignment: LV_ALIGN_CENTER (same as analog clock)
   - Removed digital time label from above analog clock

3. **Analog Clock Sizing**
   - Increased from 126x126 to 139x139 (110% increase as requested)

4. **NVS Storage**
   - Namespace: "lindi_cfg"
   - Key: "digital_mode"
   - Type: uint8_t (0=analog, 1=digital)
   - Functions created:
     * `load_digital_clock_mode_setting()` - loads preference on startup
     * `save_digital_clock_mode_setting()` - saves when button pressed

5. **Visibility Logic**
   - Initial state loaded from NVS on startup
   - Toggle callback switches visibility and saves new state
   - Both clocks exist in memory, only one visible at a time

### Technical Issues Encountered

1. **Font Not Enabled**
   - Problem: Montserrat 12 and 48 not compiled in
   - Solution: Enabled CONFIG_LVGL_FONT_MONTSERRAT_12=y and CONFIG_LVGL_FONT_MONTSERRAT_48=y in sdkconfig

2. **Partition Size Too Small**
   - Problem: Binary size 0x10f320 exceeded 1MB partition (0x100000)
   - Root cause: Adding two large fonts increased binary size
   - Solution: 
     * Created custom partitions.csv with 2MB app partition
     * Changed CONFIG_PARTITION_TABLE_CUSTOM=y in sdkconfig
     * Updated CONFIG_PARTITION_TABLE_FILENAME="partitions.csv"

---

## MPU6050 Gyroscope/Accelerometer Integration

### Objective
Integrate MPU6050 6-axis motion sensor to display readings on serial monitor every second.

### Work Completed

#### 1. Documentation Created
- **File**: `documentation/gyro_mpu6050.md` (463 lines)
- Comprehensive MPU6050 reference including:
  - Hardware pinout (all 8 pins: VCC, GND, SCL, SDA, XCL, XDA, AD0, INT)
  - I2C addresses: 0x68 (AD0=GND), 0x69 (AD0=VCC)
  - Register map and initialization procedures
  - Code examples for reading sensor data
  - Troubleshooting guide
  - Library references

#### 2. Code Integration
- **File**: `main/main.c`
  - Added I2C driver support (`#include "driver/i2c.h"`)
  - I2C configuration:
    ```c
    #define I2C_MASTER_SCL_IO    22  // Matches user's wiring
    #define I2C_MASTER_SDA_IO    21  // Matches user's wiring
    #define I2C_MASTER_NUM       I2C_NUM_0
    #define I2C_MASTER_FREQ_HZ   100000
    ```
  - MPU6050 functions implemented:
    - `i2c_scan()` - Scans I2C bus from address 0x01 to 0x7F
    - `i2c_master_init()` - Configures I2C with pull-ups enabled
    - `mpu6050_init()` - Tries addresses 0x68 then 0x69, reads WHO_AM_I, wakes sensor
    - `mpu6050_read_task()` - Reads accel/gyro/temp every 1 second

- **File**: `main/CMakeLists.txt`
  - Added `driver` to REQUIRES for I2C support

#### 3. Build Issues Resolved
1. **Linker error**: clock_component.c not in CMakeLists.txt ‚Üí Added to SOURCES
2. **LVGL 7 API incompatibility**: lv_obj_get_user_data not available ‚Üí Changed to global handle `g_clock_handle`
3. **Pin configuration mismatch**: Initial code had pins swapped ‚Üí Fixed to match user's wiring

#### 4. Build & Flash Success
- Firmware built successfully (1,130,064 bytes, 46% flash usage)
- Flashed to ESP32 successfully via COM8
- WiFi connected: 192.168.1.149
- Time synchronized via SNTP
- Display and touch initialized correctly

### üî¥ Current Problem: MPU6050 Not Detected

#### Symptoms
```
I (670)  LittlevGL Demo: Scanning I2C bus...
I (700)  LittlevGL Demo: I2C scan complete
E (700)  LittlevGL Demo: MPU6050 not found at 0x68, trying 0x69...
E (700)  LittlevGL Demo: MPU6050 not found at either 0x68 or 0x69: ESP_ERR_TIMEOUT
W (710)  LittlevGL Demo: MPU6050 initialization failed, continuing without sensor
```

**Critical finding**: I2C scan found **ZERO devices** on the bus.

#### User's Hardware Setup (Confirmed)
- **SDA**: Connected to GPIO21
- **SCL**: Connected to GPIO22
- **VCC**: Connected to 3.3V
- **GND**: Connected to GND
- **AD0**: Not connected (floating)
- **XCL/XDA/INT**: Not connected
- **LED Status**: ON (confirms VCC/GND working)

#### Code Configuration (Verified Correct)
```c
#define I2C_MASTER_SCL_IO    22  // ‚úì Matches GPIO22
#define I2C_MASTER_SDA_IO    21  // ‚úì Matches GPIO21
```

#### Error Analysis
- `ESP_ERR_TIMEOUT` = no ACK response from I2C device
- Zero devices found = SDA/SCL communication completely broken
- LED working = VCC/GND connections OK
- Software configuration verified correct

### Root Cause Hypotheses (Ordered by Likelihood)

#### 1. ‚ö†Ô∏è Missing I2C Pull-up Resistors (MOST LIKELY)
Many cheap MPU6050 modules **do not have onboard pull-up resistors** on SDA/SCL lines.

**User Action Required**:
- Inspect MPU6050 module visually
- Look near SDA/SCL pins for small resistors marked "472" (4.7kŒ©) or "103" (10kŒ©)
- If absent, add external 4.7kŒ© resistors:
  - One from SDA (GPIO21) to 3.3V
  - One from SCL (GPIO22) to 3.3V

#### 2. Bad Physical Connections
- Loose wires in breadboard
- Wire gauge too thin (high resistance)
- Wires too long (>30cm)

**User Action Required**:
- Use multimeter to verify continuity:
  - ESP32 GPIO21 ‚Üî MPU6050 SDA pin
  - ESP32 GPIO22 ‚Üî MPU6050 SCL pin
  - ESP32 3.3V ‚Üî MPU6050 VCC pin
  - ESP32 GND ‚Üî MPU6050 GND pin
- Measure voltage at MPU6050 VCC pin (should be 3.3V ¬±0.1V)
- Check for shorts between adjacent pins

#### 3. Floating AD0 Pin
AD0 determines I2C address but should not be left floating.

**User Action Required**:
- Connect AD0 to GND (for address 0x68)
- Alternatively, connect to VCC (for address 0x69)

#### 4. Damaged MPU6050 Module
Module may be damaged by ESD or overvoltage.

**User Action Required**:
- Try different MPU6050 module if available

### Next Session Action Plan

#### Step 1: Hardware Inspection (User Action - In Progress)
- [ ] Check MPU6050 module for onboard pull-up resistors
- [ ] Measure continuity of all 4 connections with multimeter
- [ ] Measure voltage at MPU6050 VCC pin (should be 3.3V ¬±0.1V)
- [ ] Check for shorts between SDA/SCL/VCC/GND pins

#### Step 2: Add Pull-up Resistors (If Missing)
- [ ] Solder or breadboard 4.7kŒ© resistor from GPIO21 to 3.3V
- [ ] Solder or breadboard 4.7kŒ© resistor from GPIO22 to 3.3V
- [ ] Press RST button on ESP32
- [ ] Check serial monitor for I2C scan results

#### Step 3: Connect AD0 Pin
- [ ] Connect AD0 pin to GND (for address 0x68)
- [ ] Press RST button
- [ ] Check serial monitor

#### Step 4: Verify Communication
If I2C scan finds device:
- [ ] Note the address found (0x68 or 0x69)
- [ ] Verify WHO_AM_I register reads 0x68
- [ ] Monitor serial for sensor readings every 1 second
- [ ] Test by moving/rotating sensor

### Quick Reference Commands

```powershell
# Monitor serial output
idf.py -p COM8 monitor

# Rebuild and flash
idf.py -p COM8 build flash monitor
```

### Expected Output (When Working)
```
I (670)  LittlevGL Demo: Scanning I2C bus...
I (670)  LittlevGL Demo: Found device at address: 0x68    ‚Üê Should see this
I (700)  LittlevGL Demo: I2C scan complete
I (710)  LittlevGL Demo: MPU6050 initialized successfully, WHO_AM_I = 0x68
I (1720) LittlevGL Demo: Accel: X=0.05g Y=0.02g Z=1.01g | Gyro: X=0.12¬∞/s Y=-0.34¬∞/s Z=0.08¬∞/s | Temp: 28.5¬∞C
```

### Technical Details

#### I2C Specifications
- **Protocol**: I2C master mode
- **Speed**: 100kHz (standard mode)
- **Pull-ups**: Enabled in software (may not be sufficient without hardware pull-ups)
- **Required pull-up value**: 4.7kŒ© typical (range: 2.2kŒ© - 10kŒ©)

#### MPU6050 Specifications
- **Chip**: InvenSense MPU-6050
- **Interface**: I2C (up to 400kHz)
- **Supply voltage**: 2.375V - 3.46V (3.3V nominal)
- **I2C addresses**: 0x68 (AD0=LOW), 0x69 (AD0=HIGH)
- **Key Registers**:
  - WHO_AM_I (0x75): Should read 0x68
  - PWR_MGMT_1 (0x6B): Write 0x00 to wake up
  - ACCEL_XOUT_H (0x3B): Start of 14-byte data block

#### ESP32 I2C Pins
- **GPIO21**: I2C0 SDA (default)
- **GPIO22**: I2C0 SCL (default)
- **Internal pull-ups**: ~45kŒ© (too weak for reliable I2C)
- **External pull-ups required**: 4.7kŒ© recommended

### Status Summary

‚úÖ **Completed**:
- Documentation created
- Code implemented and integrated
- Build system fixed
- Firmware flashed successfully
- WiFi and time sync working
- Display and clock component working

‚ùå **Blocked**:
- MPU6050 I2C communication (hardware issue)
- Sensor readings not available

‚è≥ **Pending User Action**:
- Measure wire connections with multimeter
- Check for pull-up resistors on MPU6050 module
- Add external pull-ups if needed
- Connect AD0 pin to GND

### Hardware Inspection Results

#### User Actions Completed ‚úÖ
1. **Continuity Check**: All 4 connections verified with multimeter - clean solders confirmed
2. **MPU6050 Board Inspection**: Photo analysis shows SMD resistors present on board (pull-ups ARE installed)
3. **Wiring Verification**: 
   - SDA on GPIO21 (IO21) - Correct ‚úì
   - SCL on GPIO22 (IO22) - Correct ‚úì
   - This is the ESP32 **standard I2C configuration** - no rewiring needed

#### Key Findings
- ‚úÖ Pull-up resistors present on MPU6050 module
- ‚úÖ All solder connections verified clean and solid
- ‚úÖ Wiring matches ESP32 default I2C pins (most compatible configuration)
- ‚ùå Still getting zero I2C devices detected
- ‚ö†Ô∏è AD0 pin currently floating (should be connected to GND or VCC)

### Code Changes Pending (Not Yet Flashed)
- I2C frequency reduced from 100kHz to 50kHz (in code but not flashed)
- Diagnostic logging enhanced
- User decided to defer flashing until tomorrow

### Tomorrow's Troubleshooting Plan
**Hardware Swap Testing** (isolate faulty component):
1. Try different ESP32 + same MPU6050
2. Try same ESP32 + different MPU6050 
3. This will determine if ESP32 I2C hardware or MPU6050 module is faulty

**Additional Steps**:
- Connect AD0 pin to GND (forces address 0x68, prevents floating state)
- Flash 50kHz I2C speed code
- If still no detection ‚Üí likely faulty MPU6050 or ESP32 I2C peripheral

### Documentation Updates
- Updated `documentation/ai-prompt.md` to include PDF datasheets:
  - `2.8‚î§√æ-ESP32-WROOM-32 Specifications-EN.pdf` - Board specs and GPIO capabilities
  - `ESP32_CREEN.pdf` - Display module specifications
  - AI agents should reference these PDFs when troubleshooting GPIO/I2C/SPI/power issues

### Notes
- Software is complete and correct
- Hardware troubleshooting required before proceeding
- LED on MPU6050 confirms power is working
- Zero I2C devices despite pull-ups and clean connections ‚Üí likely hardware fault
- GPIO21/22 configuration verified as ESP32 standard (best practice)

3. **Flash Size Mismatch**
   - Problem: Partition table requires 2.1MB but flash configured as 2MB
   - Solution: Changed flash size to 4MB (CONFIG_ESPTOOLPY_FLASHSIZE_4MB=y)

### Files Modified

- main/main.c:
  * Added `digital_clock_mode` static variable
  * Added `load_digital_clock_mode_setting()` function
  * Added `save_digital_clock_mode_setting()` function
  * Added `digital_clock_toggle_cb()` callback
  * Modified clock widget creation to include toggle button
  * Modified clock fonts and sizing
  * Added initial visibility logic

- partitions.csv (NEW):
  * nvs: 24KB @ 0x9000
  * phy_init: 4KB @ 0xf000
  * factory: 2MB @ 0x10000

- sdkconfig:
  * Enabled LVGL_FONT_MONTSERRAT_12
  * Enabled LVGL_FONT_MONTSERRAT_48
  * Changed to custom partition table
  * Changed flash size from 2MB to 4MB

### Build Status
- ‚úÖ Initial build with test mode completed successfully
- ‚úÖ Translations and cleanup applied:
  * All Chinese comments translated to English  
  * Project renamed from lvgl-demo to lindi
  * Test mode removed - now showing actual time
- ‚úÖ Second build in progress with real-time display

### Next Steps (After Verification)
1. Complete build and flash to device
2. Test toggle button functionality
3. Verify analog clock hand alignment still correct
4. Verify digital clock displays properly at 48pt
5. Test NVS persistence across reboots
6. Remove/comment test mode code once analog clock verified working

### Notes
- Test mode still active (cycles through 01:10:15, 15:00:20, 17:40:50 every 10 seconds)
- Need to remove test mode for production use
- Analog clock final configuration: 360¬∞, 60 tick marks, rotation_offset=30
