# Session Notes - December 20, 2025

## Issue Investigated
Screen brightness dip/flicker occurring every second or slightly faster after adding digital clock and WiFi connectivity.

## Work Performed

### 1. Initial Investigation
- User reported visible brightness dip on screen refresh
- Verified it's not a power issue
- Suspected the digital clock update function causing screen refreshes

### 2. Optimization Attempt
- Modified `clock_update_task()` in [main.c](../main/main.c#L618-L645)
- Added text comparison before updating label: only call `lv_label_set_text()` if time string actually changed
- Goal: Prevent unnecessary LVGL invalidations and screen redraws
- **Result**: Dip still present after flashing

### 3. Diagnostic Test
- Disabled clock update task entirely by commenting out `lv_task_create()` call
- Line 455 in main.c now has task creation commented out
- Build successful, ready to flash for verification
- **Purpose**: Determine if clock update is truly the cause of the brightness dip

### 4. Documentation Update
- Updated [documentation/ai-prompt.md](../documentation/ai-prompt.md)
- Added build automation section:
  - ESP-IDF root path: `e:\Dev\Espressif`
  - Auto-build and flash instructions
  - Command reference for future sessions

## Current Status
- Code changes compiled successfully
- Flash to device **PENDING** - connection issues with COM3
- Build artifact ready at: `build/lvgl-demo.bin`

## Next Steps
1. Flash the test build (with clock disabled) to device
2. Observe if brightness dip disappears:
   - **If YES**: Issue is with clock update mechanism - investigate LVGL refresh optimization
   - **If NO**: Look elsewhere - possibly LVGL task handler, WiFi activity, or display driver
3. Consider alternative approaches:
   - Change LVGL buffer configuration
   - Adjust display driver timing
   - Investigate if WiFi/SNTP polling is causing periodic activity
   - Check if performance monitor is still active

## Technical Notes
- Clock was set to update every 1000ms via `lv_task_create()`
- LVGL uses double buffering: `buf1` and `buf2` in `DISP_BUF_SIZE`
- Display: ILI9341 320x240 on HSPI (SPI2_HOST)
- Current FPS indicator was disabled by default but can be toggled

## Files Modified
- `main/main.c` - Clock update optimization + disabled task for testing
- `documentation/ai-prompt.md` - Added automation and ESP-IDF path info

## Build Info
- Build successful: `0xf2430 bytes` (5% free space remaining)
- Warnings: Unused `TAG` variable, unused `clock_update_task` function (expected while disabled)
